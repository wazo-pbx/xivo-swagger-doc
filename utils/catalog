#!/usr/bin/env python

# -*- coding: utf-8 -*-
# Copyright 2016-2019 The Wazo Authors  (see the AUTHORS file)
# SPDX-License-Identifier: GPL-3.0+

import abc
import click
import fnmatch
import json
import os
import shutil
import yaml


class SpecScanner(object):

    def __init__(self, root):
        self.root = root

    def scan(self):
        for path, dirs, files in os.walk(self.root, followlinks=True):
            files = fnmatch.filter(files, '*.yml')
            for filepath, spec in self.filter_specs(path, files):
                yield filepath, spec

    def filter_specs(self, path, files):
        for filename in files:
            filepath = os.path.join(path, filename)
            spec = self.load_spec(filepath)
            if spec and self.is_swagger_spec(spec):
                yield filepath, spec

    def load_spec(self, filepath):
        with open(filepath) as f:
            try:
                return yaml.load(f.read())
            except ValueError:
                return None

    def is_swagger_spec(self, spec):
        if 'swagger' not in spec:
            return False
        return str(spec['swagger']) >= "2"


class CatalogBuilder(object):

    __metaclass__ = abc.ABCMeta

    index_filename = "index.json"

    def __init__(self, destination):
        self.destination = destination

    @abc.abstractmethod
    def build(self, scanner):
        pass

    def write_index(self, items):
        items = self.sort_items(items)
        catalog = {'apis': items}
        index_path = os.path.join(self.destination, self.index_filename)
        data = json.dumps(catalog, indent=4, separators=(',', ': '))
        with open(index_path, 'w') as f:
            f.write(data)

    def sort_items(self, items):
        return sorted(items, key=lambda i: i['title'].lower())


class StaticBuilder(CatalogBuilder):

    def __init__(self, destination, prefix="/doc/catalog"):
        super(StaticBuilder, self).__init__(destination)
        self.prefix = prefix

    def build(self, scanner):
        items = []
        for filepath, spec in scanner.scan():
            items.append(self.build_item(spec))
            self.copy_spec(spec, filepath)

        self.write_index(items)

    def build_item(self, spec):
        url = "{}/{}.yml".format(self.prefix, spec['x-xivo-name'])
        return {'title': spec['info']['title'],
                'url': url}

    def copy_spec(self, spec, filepath):
        filename = "{}.yml".format(spec['x-xivo-name'])
        destination = os.path.join(self.destination, filename)
        shutil.copy(filepath, destination)


@click.command()
@click.argument('specs', type=click.Path(exists=True, file_okay=False))
@click.option('--destination', default='catalog', type=click.Path(file_okay=False))
@click.option('--prefix', default="/catalog")
def build_static(specs, destination, prefix):
    if not os.path.exists(destination):
        os.makedirs(destination)
    scanner = SpecScanner(specs)
    builder = StaticBuilder(destination, prefix=prefix)
    builder.build(scanner)


if __name__ == "__main__":
    group = click.Group()
    group.add_command(build_static)
    group()
